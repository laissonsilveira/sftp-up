#!/bin/bash
. /etc/init.d/functions

TMP_DIR=/home2/tmp/install
APP_NAME=c-sync-server
APP_PATH=/home2/${APP_NAME}
APP_CONFIG_PATH=config/default.json
APP_SERVICE_NAME=c-sync
APP_SERVICE=/etc/init.d/${APP_SERVICE_NAME}
BKP_DIR=/home2/tmp/bkp_${APP_NAME}_`date '+%Y%m%d_%H%M%S'`

echo ""
if ! [ -z $(ps aux | awk '/home2\/c-sync-server\/bin\/c-sync-server/ {print $2}') ] ; then 
	echo "Serviço '$APP_SERVICE_NAME' ainda está execução. Favor finalizar antes da instalação"
	exit 1
fi

echo "-----------------------------------------"
echo ""
echo "Instalacao do C-Sync Server"

############################################
# Backup da versao anterior
############################################
if [ -d $APP_PATH ]; then
	echo ""
	echo "Realizando backup da versao anterior"
	mkdir -p $BKP_DIR
	mv $APP_PATH/* $BKP_DIR
	echo ""
	echo "Backup do C-Sync Server feito em $BKP_DIR"
fi

############################################
# Instalação do C-Sync Server
############################################
echo ""
echo "Realizando instalacao do C-Sync Server"
mkdir -p $APP_PATH /home2/axs/ ;
if [ ! -d "/axs" ]; then ln -s /home2/axs/ axs ; fi
mkdir -p /axs/traces
cp -pR $TMP_DIR/$APP_NAME/* $APP_PATH
chmod +x $APP_PATH/init.d/$APP_SERVICE_NAME-startup.sh

############################################
# Restaurando as configuracoes do C-Sync Server
############################################
if [ -d $BKP_DIR ]; then
	echo ""
	echo "Restaurando configuracoes da instalacao anterior"
    /usr/bin/node $TMP_DIR/basic-config-restorer.js $BKP_DIR/$APP_CONFIG_PATH $APP_PATH/$APP_CONFIG_PATH
fi

############################################
# Instalando como servico
############################################
echo ""
echo "Configurando servico de inicializacao do C-Sync Server"
if [ -e "/etc/systemd/system/$APP_SERVICE_NAME.service" ] ; then
	systemctl stop $APP_SERVICE_NAME
	rm -f /etc/systemd/system/$APP_SERVICE_NAME.service
fi
cp -p $APP_PATH/init.d/$APP_SERVICE_NAME.service /etc/systemd/system/ > /dev/null 2>&1
systemctl daemon-reload
systemctl enable $APP_SERVICE_NAME.service 1> /dev/null

############################################
# Limpeza
############################################
echo ""
echo "Limpando arquivos de instalacao"
rm -fR $TMP_DIR
rm $0

echo ""
echo "Instalacao finalizada"